<!DOCTYPE html>
<html>
<head>
    <title>Butterfly Hello World Example</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
</head>
<body class="container">
    <h2>Overview</h2>
    <p>This example simply sends a "Hello World" from the client to the server and has the server echo "Hello World" back to the client in an alert() box.</p>

    <h2>Detailed Data Flow</h2>
    <ol>
        <li>Client creates a "channel" to the server (using a WebSocket in this example)</li>
        <li>When the channel connects, client executes a POST to /api/hello-world/message on the server sending "Hello World"</li>
        <li>When the server receives the POST to /api/hello-world/message, the server INSERTs a "Hello World" record in the database which publishes a "Hello World" INSERT data event which triggers sending "Hello World" to the client over the channel</li>
        <li>When the client receives the data event over the channel, the client calls alert() to display the message</li>
    </ol>

    <h2>Background</h2>
    <p>Like many Hello World examples, this is a rather convuluted way to send "Hello World" to a server and have it echoed back. The real power in this framework is having changes automatically update multiple views of multiple clients. For example, executing an UPDATE to change a department name from "HR" to "New HR" might automatically update all clients viewing employees by department, all clients viewing a list of departments, etc.</p>

    <h2>The Code</h2>
    <p>Server: <a href="https://github.com/firesharkstudios/Butterfly/blob/master/Butterfly.Examples/HelloWorldExample.cs">HelloWorldExample.cs</a>, Client: <a href="https://github.com/firesharkstudios/Butterfly/blob/master/Butterfly.Client.Web/examples/hello-world/index.html">index.html</a></p>

    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="/js/butterfly.channel.websocket.js"></script>
    <script src="/js/butterfly.util.js"></script>
    <script>
        // Create a channel to the server
        let channelClient = new butterfly.channel.WebSocketChannelClient({
            url: '/hello-world',
            auth: 'Custom ' + butterfly.util.uuidv4(),
            onSubscriptionsUpdated: function () {
                // Post a "Hello World" message to the server
                $.ajax('/api/hello-world/message', {
                    method: 'POST',
                    data: JSON.stringify('Hello World'),
                    processData: false,
                });
            }
        });
        channelClient.subscribe(function (dataEventTransaction) {
            // When an INSERT data event is received, display the text field value in an alert box
            if (dataEventTransaction.dataEvents.length == 1 && dataEventTransaction.dataEvents[0].dataEventType == 'Insert') alert(dataEventTransaction.dataEvents[0].record.text);
        });
        channelClient.start();

    </script>
</body>
</html>